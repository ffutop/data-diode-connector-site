import{_ as n,c as s,o as l,a6 as e,j as a}from"./chunks/framework.Cpr3xyXy.js";const f=JSON.parse('{"title":"流量控制机制与调优指南","description":"","frontmatter":{},"headers":[],"relativePath":"zh-CN/flow_control.md","filePath":"zh-CN/flow_control.md","lastUpdated":1764468807000}'),r={name:"zh-CN/flow_control.md"},i={tabindex:"0",class:"MathJax",jax:"SVG",display:"true",style:{direction:"ltr",display:"block","text-align":"center",margin:"1em 0",position:"relative"}},T={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-2.172ex"},xmlns:"http://www.w3.org/2000/svg",width:"37.334ex",height:"5.475ex",role:"img",focusable:"false",viewBox:"0 -1460 16501.6 2420","aria-hidden":"true"};function d(Q,t,o,h,p,c){return l(),s("div",null,[t[2]||(t[2]=e(`<h1 id="流量控制机制与调优指南" tabindex="-1">流量控制机制与调优指南 <a class="header-anchor" href="#流量控制机制与调优指南" aria-label="Permalink to “流量控制机制与调优指南”">​</a></h1><p>在单向网闸环境中，流量控制是保障系统稳定性的最关键因素。由于物理层面的单向性，出口代理无法向入口代理发送“ACK 确认”、“窗口已满”或“降低发送速率”的反馈信号。</p><p>如果入口代理以线速（Line Speed）全速发送数据，而网闸硬件或接收端处理速度稍慢，就会发生<strong>静默丢包（Silent Packet Loss）</strong>。</p><p>网闸连接器通过应用层的<strong>主动发送速率限制</strong>来解决这个问题。</p><h2 id="工作原理" tabindex="-1">工作原理 <a class="header-anchor" href="#工作原理" aria-label="Permalink to “工作原理”">​</a></h2><p>网闸连接器的流控机制位于入口代理（发送端）的 <code>transport-udp-send</code> 组件中。</p><p>其实现非常直接：在发送每一个 UDP 数据包之前，发送线程会强制暂停一段指定的时间。</p><h3 id="核心逻辑" tabindex="-1">核心逻辑 <a class="header-anchor" href="#核心逻辑" aria-label="Permalink to “核心逻辑”">​</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 伪代码逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> send_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(packet, delay_ms) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. 强制休眠</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delay_ms </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(delay_ms);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. 发送数据包</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    udp_socket</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(packet);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>这种机制产生的效果是：<strong>人为拉大数据包之间的间隔（Inter-Packet Gap）</strong>，从而降低瞬时吞吐量，确保其不超过物理网闸的带宽限制。</p><h3 id="涉及的参数" tabindex="-1">涉及的参数 <a class="header-anchor" href="#涉及的参数" aria-label="Permalink to “涉及的参数”">​</a></h3><ul><li>数据包大小: 网闸连接器默认尽可能填满 UDP 数据包，最大载荷约为 <strong>64KB</strong> (65498 字节)。</li><li>延迟: 由配置文件中的 <code>send_delay_ms</code> 参数控制。</li></ul><h2 id="理论吞吐量计算" tabindex="-1">理论吞吐量计算 <a class="header-anchor" href="#理论吞吐量计算" aria-label="Permalink to “理论吞吐量计算”">​</a></h2><p>由于网闸连接器每个数据包大约承载 64KB 数据，我们可以估算不同 <code>send_delay_ms</code> 设置下的<strong>最大理论带宽</strong>。</p><p><strong>公式</strong>：</p>`,15)),a("mjx-container",i,[(l(),s("svg",T,[...t[0]||(t[0]=[e('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">吞</text><text data-variant="normal" transform="translate(1000,0) scale(1,-1)" font-size="884px" font-family="serif">吐</text><text data-variant="normal" transform="translate(2000,0) scale(1,-1)" font-size="884px" font-family="serif">量</text><path data-c="20" d="" transform="translate(3000,0)" style="stroke-width:3;"></path><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z" transform="translate(3250,0)" style="stroke-width:3;"></path><path data-c="4D" d="M132 622Q125 629 121 631T105 634T62 637H29V683H135Q221 683 232 682T249 675Q250 674 354 398L458 124L562 398Q666 674 668 675Q671 681 683 682T781 683H887V637H854Q814 636 803 634T785 622V61Q791 51 802 49T854 46H887V0H876Q855 3 736 3Q605 3 596 0H585V46H618Q660 47 669 49T688 61V347Q688 424 688 461T688 546T688 613L687 632Q454 14 450 7Q446 1 430 1T410 7Q409 9 292 316L176 624V606Q175 588 175 543T175 463T175 356L176 86Q187 50 261 46H278V0H269Q254 3 154 3Q52 3 37 0H29V46H46Q78 48 98 56T122 69T132 86V622Z" transform="translate(3639,0)" style="stroke-width:3;"></path><path data-c="42" d="M131 622Q124 629 120 631T104 634T61 637H28V683H229H267H346Q423 683 459 678T531 651Q574 627 599 590T624 512Q624 461 583 419T476 360L466 357Q539 348 595 302T651 187Q651 119 600 67T469 3Q456 1 242 0H28V46H61Q103 47 112 49T131 61V622ZM511 513Q511 560 485 594T416 636Q415 636 403 636T371 636T333 637Q266 637 251 636T232 628Q229 624 229 499V374H312L396 375L406 377Q410 378 417 380T442 393T474 417T499 456T511 513ZM537 188Q537 239 509 282T430 336L329 337H229V200V116Q229 57 234 52Q240 47 334 47H383Q425 47 443 53Q486 67 511 104T537 188Z" transform="translate(4556,0)" style="stroke-width:3;"></path><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z" transform="translate(5264,0)" style="stroke-width:3;"></path><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(5764,0)" style="stroke-width:3;"></path><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" transform="translate(6158,0)" style="stroke-width:3;"></path></g><g data-mml-node="mo" transform="translate(6824.8,0)"><path data-c="2248" d="M55 319Q55 360 72 393T114 444T163 472T205 482Q207 482 213 482T223 483Q262 483 296 468T393 413L443 381Q502 346 553 346Q609 346 649 375T694 454Q694 465 698 474T708 483Q722 483 722 452Q722 386 675 338T555 289Q514 289 468 310T388 357T308 404T224 426Q164 426 125 393T83 318Q81 289 69 289Q55 289 55 319ZM55 85Q55 126 72 159T114 210T163 238T205 248Q207 248 213 248T223 249Q262 249 296 234T393 179L443 147Q502 112 553 112Q609 112 649 141T694 220Q694 249 708 249T722 217Q722 153 675 104T555 55Q514 55 468 76T388 123T308 170T224 192Q164 192 125 159T83 84Q80 55 69 55Q55 55 55 85Z" style="stroke-width:3;"></path></g><g data-mml-node="mfrac" transform="translate(7880.6,0)"><g data-mml-node="mtext" transform="translate(220,710)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" style="stroke-width:3;"></path><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)" style="stroke-width:3;"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(778,0)" style="stroke-width:3;"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(1278,0)" style="stroke-width:3;"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(1778,0)" style="stroke-width:3;"></path><path data-c="20" d="" transform="translate(2278,0)" style="stroke-width:3;"></path><path data-c="4D" d="M132 622Q125 629 121 631T105 634T62 637H29V683H135Q221 683 232 682T249 675Q250 674 354 398L458 124L562 398Q666 674 668 675Q671 681 683 682T781 683H887V637H854Q814 636 803 634T785 622V61Q791 51 802 49T854 46H887V0H876Q855 3 736 3Q605 3 596 0H585V46H618Q660 47 669 49T688 61V347Q688 424 688 461T688 546T688 613L687 632Q454 14 450 7Q446 1 430 1T410 7Q409 9 292 316L176 624V606Q175 588 175 543T175 463T175 356L176 86Q187 50 261 46H278V0H269Q254 3 154 3Q52 3 37 0H29V46H46Q78 48 98 56T122 69T132 86V622Z" transform="translate(2528,0)" style="stroke-width:3;"></path><path data-c="42" d="M131 622Q124 629 120 631T104 634T61 637H28V683H229H267H346Q423 683 459 678T531 651Q574 627 599 590T624 512Q624 461 583 419T476 360L466 357Q539 348 595 302T651 187Q651 119 600 67T469 3Q456 1 242 0H28V46H61Q103 47 112 49T131 61V622ZM511 513Q511 560 485 594T416 636Q415 636 403 636T371 636T333 637Q266 637 251 636T232 628Q229 624 229 499V374H312L396 375L406 377Q410 378 417 380T442 393T474 417T499 456T511 513ZM537 188Q537 239 509 282T430 336L329 337H229V200V116Q229 57 234 52Q240 47 334 47H383Q425 47 443 53Q486 67 511 104T537 188Z" transform="translate(3445,0)" style="stroke-width:3;"></path><path data-c="20" d="" transform="translate(4153,0)" style="stroke-width:3;"></path><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z" transform="translate(4403,0)" style="stroke-width:3;"></path><text data-variant="normal" transform="translate(4792,0) scale(1,-1)" font-size="884px" font-family="serif">包</text><text data-variant="normal" transform="translate(5792,0) scale(1,-1)" font-size="884px" font-family="serif">大</text><text data-variant="normal" transform="translate(6792,0) scale(1,-1)" font-size="884px" font-family="serif">小</text><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" transform="translate(7792,0)" style="stroke-width:3;"></path></g><g data-mml-node="mtext" transform="translate(2039.5,-710)"><path data-c="44" d="M130 622Q123 629 119 631T103 634T60 637H27V683H228Q399 682 419 682T461 676Q504 667 546 641T626 573T685 470T708 336Q708 210 634 116T442 3Q429 1 228 0H27V46H60Q102 47 111 49T130 61V622ZM593 338Q593 439 571 501T493 602Q439 637 355 637H322H294Q238 637 234 628Q231 624 231 344Q231 62 232 59Q233 49 248 48T339 46H350Q456 46 515 95Q561 133 577 191T593 338Z" style="stroke-width:3;"></path><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(764,0)" style="stroke-width:3;"></path><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(1208,0)" style="stroke-width:3;"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(1486,0)" style="stroke-width:3;"></path><path data-c="79" d="M69 -66Q91 -66 104 -80T118 -116Q118 -134 109 -145T91 -160Q84 -163 97 -166Q104 -168 111 -168Q131 -168 148 -159T175 -138T197 -106T213 -75T225 -43L242 0L170 183Q150 233 125 297Q101 358 96 368T80 381Q79 382 78 382Q66 385 34 385H19V431H26L46 430Q65 430 88 429T122 428Q129 428 142 428T171 429T200 430T224 430L233 431H241V385H232Q183 385 185 366L286 112Q286 113 332 227L376 341V350Q376 365 366 373T348 383T334 385H331V431H337H344Q351 431 361 431T382 430T405 429T422 429Q477 429 503 431H508V385H497Q441 380 422 345Q420 343 378 235T289 9T227 -131Q180 -204 113 -204Q69 -204 44 -177T19 -116Q19 -89 35 -78T69 -66Z" transform="translate(1986,0)" style="stroke-width:3;"></path><path data-c="20" d="" transform="translate(2514,0)" style="stroke-width:3;"></path><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z" transform="translate(2764,0)" style="stroke-width:3;"></path><text data-variant="normal" transform="translate(3153,0) scale(1,-1)" font-size="884px" font-family="serif">秒</text><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" transform="translate(4153,0)" style="stroke-width:3;"></path></g><rect width="8381" height="60" x="120" y="220"></rect></g></g></g>',1)])])),t[1]||(t[1]=a("mjx-assistive-mml",{unselectable:"on",display:"block",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",overflow:"hidden",width:"100%"}},[a("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[a("mtext",null,"吞吐量 (MB/s)"),a("mo",null,"≈"),a("mfrac",null,[a("mtext",null,"0.064 MB (包大小)"),a("mtext",null,"Delay (秒)")])])],-1))]),t[3]||(t[3]=e('<table tabindex="0"><thead><tr><th style="text-align:left;">send_delay_ms</th><th style="text-align:left;">每秒包数 (PPS)</th><th style="text-align:left;">理论最大带宽 (MB/s)</th><th style="text-align:left;">理论最大带宽 (Mbps)</th><th style="text-align:left;">适用场景 (估算)</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>0</strong></td><td style="text-align:left;">CPU 极限</td><td style="text-align:left;">100+ MB/s</td><td style="text-align:left;">1 Gbps+</td><td style="text-align:left;">万兆网闸 / 纯软件测试</td></tr><tr><td style="text-align:left;"><strong>1</strong></td><td style="text-align:left;">~1000</td><td style="text-align:left;">~64 MB/s</td><td style="text-align:left;">~512 Mbps</td><td style="text-align:left;">千兆网闸 (推荐起点)</td></tr><tr><td style="text-align:left;"><strong>2</strong></td><td style="text-align:left;">~500</td><td style="text-align:left;">~32 MB/s</td><td style="text-align:left;">~256 Mbps</td><td style="text-align:left;">300-500Mbps 带宽</td></tr><tr><td style="text-align:left;"><strong>5</strong></td><td style="text-align:left;">~200</td><td style="text-align:left;">~12.8 MB/s</td><td style="text-align:left;">~100 Mbps</td><td style="text-align:left;">百兆网闸</td></tr><tr><td style="text-align:left;"><strong>10</strong></td><td style="text-align:left;">~100</td><td style="text-align:left;">~6.4 MB/s</td><td style="text-align:left;">~50 Mbps</td><td style="text-align:left;">低速/不稳定链路</td></tr></tbody></table><blockquote><p><strong>注意</strong>：实际吞吐量会略低于理论值，因为系统调用（Syscall）和网络栈处理也需要消耗微秒级的时间。</p></blockquote><h2 id="调优策略-tuning-strategy" tabindex="-1">调优策略 (Tuning Strategy) <a class="header-anchor" href="#调优策略-tuning-strategy" aria-label="Permalink to “调优策略 (Tuning Strategy)”">​</a></h2><p>调整流控参数是一个试错的过程。建议遵循以下步骤：</p><h3 id="第一步-基准测试" tabindex="-1">第一步：基准测试 <a class="header-anchor" href="#第一步-基准测试" aria-label="Permalink to “第一步：基准测试”">​</a></h3><p>将 <code>send_delay_ms</code> 设置为一个保守值（例如 <code>5</code>，对应约 100Mbps）。</p><h3 id="第二步-监控丢包" tabindex="-1">第二步：监控丢包 <a class="header-anchor" href="#第二步-监控丢包" aria-label="Permalink to “第二步：监控丢包”">​</a></h3><p>观察<strong>出口代理 (接收端)</strong> 的日志或监控指标 (<code>ddc.egress.packet_loss</code>)。</p><ul><li>如果 <code>packet_loss &gt; 0</code>：说明发送太快，或者中间网络/网闸丢包。</li><li>如果 <code>packet_loss == 0</code>：说明链路稳定。</li></ul><h3 id="第三步-逐步提速" tabindex="-1">第三步：逐步提速 <a class="header-anchor" href="#第三步-逐步提速" aria-label="Permalink to “第三步：逐步提速”">​</a></h3><ol><li>将 <code>send_delay_ms</code> 减小（例如从 <code>5</code> 降到 <code>2</code>，再降到 <code>1</code>）。</li><li>每次调整后，运行一段时间并检查<strong>出口代理</strong>端是否有丢包。</li><li><strong>找到临界点</strong>：当您开始看到少量丢包时，将 <code>send_delay_ms</code> 稍微回调一点（增加延迟）。</li></ol><h3 id="第四步-处理-0-的陷阱" tabindex="-1">第四步：处理“0”的陷阱 <a class="header-anchor" href="#第四步-处理-0-的陷阱" aria-label="Permalink to “第四步：处理“0”的陷阱”">​</a></h3><p>将 <code>send_delay_ms</code> 设置为 <code>0</code> 意味着“无限制”。</p><ul><li>在 Linux 系统上，这会导致网闸连接器尽可能快地进行 <code>sendto()</code> 系统调用。</li><li>这很容易瞬间打满 1Gbps 甚至 10Gbps 的网卡缓冲区，导致<strong>本地</strong>（发送端网卡）或<strong>交换机</strong>端口溢出。</li><li><strong>建议</strong>：除非您非常确定硬件网闸能处理线速流量，否则建议至少保留 <code>send_delay_ms = &quot;1&quot;</code>。</li></ul><h2 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-label="Permalink to “常见问题”">​</a></h2><p><strong>Q1: 为什么我设置了 <code>send_delay_ms = 1</code>，速度只有 500Mbps，跑不满我的千兆网闸？</strong></p><p>A1: <code>sleep(1ms)</code> 在操作系统层面并不保证精确的 1.000ms，通常会略多一点。此外，64KB 的包大小在 MTU=1500 的网络上会被分片成 ~45 个 IP 包，这增加了开销。如果您需要精细控制（例如 800Mbps），目前网闸连接器的毫秒级精度可能不够，建议通过增加并发（运行多条 Chain）来填充带宽。</p><p><strong>Q2: 我可以设置小数吗？例如 0.5ms？</strong></p><p>A2: 不可以。配置文件解析器将其读取为整数。如果需要更高的精度，未来版本可能会引入微秒级控制。目前建议保持整数设置。</p><p><strong>Q3: 缓冲区大小 (<code>bip_buffer_element_count</code>) 会影响流控吗？</strong></p><p>A3: 缓冲区不会影响<strong>发送速率</strong>，但它决定了<strong>抗突发能力</strong>。</p><ul><li>如果 Kafka 突然涌入 100MB 数据，而流控限制为 50MB/s。</li><li>较大的缓冲区可以暂存这 100MB，让发送端慢慢发完。</li><li>较小的缓冲区会导致 Kafka 消费者阻塞（Backpressure），暂停从 Kafka 读取。</li><li><strong>结论</strong>：配合流控使用时，适当增大缓冲区有助于平滑 Kafka 的突发流量。</li></ul>',22))])}const k=n(r,[["render",d]]);export{f as __pageData,k as default};
